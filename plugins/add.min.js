function addEventListeners(e){const t=e.querySelectorAll("input, textarea, select");t.forEach(e=>{const t=function(){saveDraftData()};e.addEventListener("input",t),eventListeners.formInputListeners.push({input:e,listener:t})});const n=document.getElementById("dropdownInput"),a=document.getElementById("dropdownOptions"),o=document.getElementById("dropdownInputContainer"),r=function(){saveDraftData()};n.addEventListener("input",r),eventListeners.tagInputListener={tagInput:n,listener:r};const s=function(e){e.target.classList.contains("dropdown-option")&&saveDraftData()};a.addEventListener("click",s),eventListeners.tagOptionsListener={tagOptions:a,listener:s};const i=function(e){e.target.classList.contains("remove-tag")&&(e.target.parentElement.remove(),console.log("标签已删除:",e.target.dataset.tag),saveDraftData())};o.addEventListener("click",i),eventListeners.containerClickListener={container:o,listener:i}}function removeEventListeners(){eventListeners.formInputListeners.forEach(({input:e,listener:t})=>{e&&t&&e.removeEventListener("input",t)}),eventListeners.tagInputListener&&eventListeners.tagInputListener.input&&eventListeners.tagInputListener.listener&&eventListeners.tagInputListener.input.removeEventListener("input",eventListeners.tagInputListener.listener),eventListeners.tagOptionsListener&&eventListeners.tagOptionsListener.tagOptions&&eventListeners.tagOptionsListener.listener&&eventListeners.tagOptionsListener.tagOptions.removeEventListener("click",eventListeners.tagOptionsListener.listener),eventListeners.containerClickListener&&eventListeners.containerClickListener.container&&eventListeners.containerClickListener.listener&&eventListeners.containerClickListener.container.removeEventListener("click",eventListeners.containerClickListener.listener)}function toggleCalendarType(e,t,n){if(showGregorian="gregorian"===e,fp&&fp.redraw(),showGregorian)document.getElementById("toggle-gregorian").classList.add("active"),document.getElementById("toggle-lunar").classList.remove("active"),n.innerText="";else if(document.getElementById("toggle-lunar").classList.add("active"),document.getElementById("toggle-gregorian").classList.remove("active"),t.length>0){const e=t[0],a=Lunar.fromDate(e),o=a.getYearInChinese(),r=a.getMonthInChinese(),s=a.getDayInChinese(),i=`${o}年 ${r}月 ${s}`;n.innerText=`农历: ${i}`}}function convertToLunar(e){var t=new Date(e);const n=Lunar.fromDate(t),a=n.getYearInChinese(),o=n.getMonthInChinese(),r=n.getDayInChinese(),s=`${a}年 ${o}月 ${r}`;return s}function setupDropdownInputContainerListener(){const e=document.getElementById("dropdownInputContainer");e.addEventListener("click",function(e){e.target.classList.contains("remove-tag")&&(e.target.parentElement.remove(),console.log("标签已删除:",e.target.dataset.tag))});const t=document.getElementById("dropdownInput");t.addEventListener("keydown",function(n){if("Enter"===n.key&&""!==t.value.trim()){const n=document.createElement("span");n.classList.add("selected-tag"),n.innerHTML=`${t.value.trim()}<span class="remove-tag" data-tag="${t.value.trim()}">×</span>`,e.insertBefore(n,t),console.log("新标签已添加:",t.value.trim()),t.value=""}}),console.log("监听器已设置")}function getSelectedTags(){let e=[];return $(".remove-tag").each(function(){e.push($(this).data("tag-id"))}),e.join(", ")}function saveDraftData(){var e=document.getElementById("event-name").value.trim(),t=(document.getElementById("event-date").value.trim(),document.getElementById("icon-svg").value.trim()),n=document.getElementById("repeat").value;let a=getSelectedTags();var o={eventName:e,eventDate:selectedDatesInfo,iconSvg:t,repeat:n,tagId:a};localStorage.setItem("draftData",JSON.stringify(o)),console.log("草稿保存了")}function padZero(e){return e<10?"0"+e:e}function isValidDateString(e){var t=/^\d{4}-\d{2}-\d{2}$/;return t.test(e)}function validateJson(e){if(!Array.isArray(e))return!1;for(var t=0;t<e.length;t++){var n=e[t];if(!(n.hasOwnProperty("id")&&n.hasOwnProperty("name")&&n.hasOwnProperty("icon")&&n.hasOwnProperty("repeat")&&n.hasOwnProperty("tagId")&&"string"==typeof n.id&&"string"==typeof n.name&&"string"==typeof n.icon&&"string"==typeof n.repeat&&"string"==typeof n.tagId))return!1;if(!n.hasOwnProperty("date"))return!1;var a=n.date;if("string"==typeof a){if(!isValidDateString(a))return!1}else{if("object"!=typeof a)return!1;if(!a.hasOwnProperty("type")||!a.hasOwnProperty("gregorian")||!a.hasOwnProperty("lunar")||"string"!=typeof a.type||"string"!=typeof a.gregorian||"string"!=typeof a.lunar)return!1}}return!0}function clearTags(){const e=dropdownInputContainer.querySelectorAll(".selected-tag");e.forEach(e=>e.remove())}function displayTags(){selectedOptions=[],updateTagsDisplay();let e=JSON.parse(localStorage.getItem("draftData"))||{},t=e.tagId||"",n=getTagNames(t,JSON.parse(localStorage.getItem("tags")));console.log("草稿dropdownInputValue名称："+n);let a=n.split(",").map(e=>e.trim()).filter(e=>""!==e);console.log("草稿标签名称："+a),$("#dropdownInputContainer .selected-tag").remove(),a.forEach(function(e){console.log(e),selectDefaultOption(e)})}function getTagNames(e,t){let n=e.split(",").map(e=>e.trim()),a=n.map(e=>{let n=t.find(t=>t.id===e);return n?n.name:null}).filter(e=>null!==e);return a.join(",")}function displayTags2(e){selectedOptions=[],updateTagsDisplay();let t=e.tagId||"",n=getTagNames(t,JSON.parse(localStorage.getItem("tags"))),a=n.split(",").map(e=>e.trim()).filter(e=>""!==e);$("#dropdownInputContainer .selected-tag").remove(),a.forEach(function(e){selectDefaultOption(e)})}function renderOptions(e=""){dropdownOptions.innerHTML="";const t=options.filter(t=>t.name.toLowerCase().includes(e.toLowerCase())&&!selectedOptions.some(e=>e.id===t.id));if(t.forEach((e,t)=>{const n=document.createElement("div");n.className="dropdown-option",n.textContent=e.name,n.dataset.id=e.id,n.onclick=(()=>selectOption(e)),n.onmouseover=(()=>updateHighlight(t)),t===highlightedIndex&&n.classList.add("highlighted"),dropdownOptions.appendChild(n)}),e&&!options.some(t=>t.name===e)){const n=document.createElement("div");n.className="dropdown-option add-option",n.textContent=`添加 "${e}"`,n.onclick=(()=>{const t=addNewTag(e);console.log("newOption:"+t),options.push(t),selectOption(t)}),n.onmouseover=(()=>updateHighlight(t.length)),dropdownOptions.appendChild(n)}dropdownOptions.style.display=t.length>0||e?"block":"none",highlightedIndex=t.length>0?0:-1,updateHighlight(highlightedIndex)}function selectOption(e){selectedOptions.some(t=>t.id===e.id)||(selectedOptions.push(e),updateTagsDisplay()),dropdownInput.value="",renderOptions(),highlightedIndex=-1}function removeOption(e){selectedOptions=selectedOptions.filter(t=>t.id!==e.id),updateTagsDisplay(),renderOptions()}function updateTagsDisplay(){const e=selectedOptions.map(e=>`<span class="selected-tag">${e.name}<span class="remove-tag" data-tag="${e.name}" data-tag-id="${e.id}">&times;</span></span>`).join("");dropdownInputContainer.innerHTML=e+'<input type="text" class="dropdown-input" id="dropdownInput" placeholder="搜索或添加标签" autocomplete="off">',dropdownInput=document.getElementById("dropdownInput"),setupInputListeners()}function setupInputListeners(){dropdownInput.addEventListener("focus",()=>{renderOptions()}),dropdownInput.addEventListener("input",()=>{renderOptions(dropdownInput.value),highlightedIndex=-1}),dropdownInput.addEventListener("keydown",e=>{const t=dropdownOptions.querySelectorAll(".dropdown-option");"ArrowDown"===e.key?(e.preventDefault(),highlightedIndex=(highlightedIndex+1)%t.length,updateHighlight(highlightedIndex)):"ArrowUp"===e.key?(e.preventDefault(),highlightedIndex=(highlightedIndex-1+t.length)%t.length,updateHighlight(highlightedIndex)):"Enter"===e.key&&(e.preventDefault(),highlightedIndex>=0&&highlightedIndex<t.length?t[highlightedIndex].click():t.length>0&&t[0].click())}),dropdownInputContainer.addEventListener("click",e=>{if(e.target.classList.contains("remove-tag")){if(e.target.classList.contains("remove-tag")){const t=e.target.getAttribute("data-tag-id"),n=options.find(e=>e.id===t);removeOption(n)}}else dropdownInput.focus(),renderOptions()})}function updateHighlight(e){highlightedIndex=e;const t=dropdownOptions.querySelectorAll(".dropdown-option");t.forEach((e,t)=>{t===highlightedIndex?(e.classList.add("highlighted"),e.scrollIntoView({block:"nearest"})):e.classList.remove("highlighted")})}function selectDefaultOption(e){const t=options.find(t=>t.name===e);t&&selectOption(t)}function generateId(){const e=getTags();let t;do{t=(1e6*Math.random()).toFixed(0).toString()}while(e.some(e=>e.id===t));return t}function getTags(){const e=JSON.parse(localStorage.getItem("tags"))||[],t=e.filter(e=>"1"!==e.id&&"2"!==e.id),n=t.sort((e,t)=>e.order-t.order);return console.log(n),n}function handleCardClick(e){var t=window.scrollY;localStorage.setItem("scrollPosition",t),options=getTags(),console.log("编辑事件："+options),setupInputListeners();var n=getEventDataById(e);fillFormWithData(n)}function getEventDataById(e){for(var t=JSON.parse(localStorage.getItem("events"))||[],n=0;n<t.length;n++)if(t[n].id===e)return t[n];return null}function fillFormWithData(e){settingsBtn.classList.toggle("hidden"),addBtn.classList.toggle("hidden"),contentList.classList.toggle("hidden"),addform.classList.toggle("hidden");var t=document.getElementById("event-name"),n=document.getElementById("event-date"),a=document.getElementById("icon-svg"),o=document.getElementById("repeat");console.log(e),displayTags2(e),t.value=e.name,n.value=getEventDate(e).date,console.log("获取到的日期为："+getEventDate(e).date),a.value=e.icon,o.value=e.repeat;var r=document.querySelector("form");r.setAttribute("pageid",e.id);var s=document.getElementById("icon-preview");s.innerHTML=e.icon}function editEventData(e,t){var n=JSON.parse(localStorage.getItem("events"))||[],a=n.findIndex(function(t){return t.id===e});-1!==a?(console.log(n[a]),console.log(t),n[a]=t,localStorage.setItem("events",JSON.stringify(n)),settingsBtn.classList.toggle("hidden"),addBtn.classList.toggle("hidden"),contentList.classList.toggle("hidden"),addform.classList.toggle("hidden"),loadEvents(getCurrentSelectedTagId()),console.log("事件数据已成功编辑并更新到 localStorage 中")):console.error("找不到要编辑的事件数据")}function deleteEventData(e){var t=JSON.parse(localStorage.getItem("events"))||[],n=t.findIndex(function(t){return t.id===e});-1!==n?(t.splice(n,1),0===t.length?localStorage.removeItem("events"):localStorage.setItem("events",JSON.stringify(t)),showMessage("删除成功"),loadEvents(getCurrentSelectedTagId()),console.log("事件数据已成功删除并更新到 localStorage 中"),renderTagsWrapper(!1,getCurrentSelectedTagName())):console.error("找不到要删除的事件数据")}function showMessage(e){var t=document.createElement("div");t.textContent=e,t.classList.add("message"),t.style.backgroundColor="white",t.style.boxShadow="0px 0px 10px rgba(0, 0, 0, 0.5)",t.style.width="150px",t.style.height="40px",t.style.lineHeight="40px",t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",document.body.appendChild(t),setTimeout(function(){t.style.opacity="1"},100),setTimeout(function(){t.style.opacity="0"},2e3),setTimeout(function(){document.body.removeChild(t)},2500)}function generateEventId(){return"event_"+Date.now()+"_"+Math.floor(1e3*Math.random())}function saveEvent(e,t,n,a,o){var r=JSON.parse(localStorage.getItem("events"))||[],s=generateEventId();r.push({id:s,name:e,date:t,icon:n,repeat:a,tagId:o}),localStorage.setItem("events",JSON.stringify(r))}function showEmptyDataMessage(){var e=document.getElementById("cardList");e.innerHTML='\n        <div class="empty-data-message">\n        <svg t="1714992812161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11214" width="32" height="32"><path d="M675.328 117.717333A425.429333 425.429333 0 0 0 512 85.333333C276.352 85.333333 85.333333 276.352 85.333333 512s191.018667 426.666667 426.666667 426.666667 426.666667-191.018667 426.666667-426.666667c0-56.746667-11.093333-112-32.384-163.328a21.333333 21.333333 0 0 0-39.402667 16.341333A382.762667 382.762667 0 0 1 896 512c0 212.074667-171.925333 384-384 384S128 724.074667 128 512 299.925333 128 512 128c51.114667 0 100.8 9.984 146.986667 29.12a21.333333 21.333333 0 0 0 16.341333-39.402667zM533.333333 362.666667a21.333333 21.333333 0 0 0-42.666666 0v170.666666a21.333333 21.333333 0 0 0 6.250666 15.082667l128 128a21.333333 21.333333 0 0 0 30.165334-30.165333L533.333333 524.501333V362.666667z" fill="#707070" p-id="11215"></path></svg>\n            <p>点击 “+” 添加你的重要时刻</p>\n        </div>'}function getEventDate(e){if("string"==typeof e.date)return{date:e.date,type:"gregorian"};if("gregorian"===e.date.type)return{date:e.date.gregorian,type:"gregorian"};if("lunar"===e.date.type)return{date:e.date.lunar,type:"lunar"};throw new Error("Unknown date format")}function getGregorianDate(e){if("string"==typeof e.date)return{date:e.date,type:"gregorian"};if("gregorian"===e.date.type)return{date:e.date.gregorian,type:"gregorian"};if("lunar"===e.date.type)return{date:e.date.gregorian,type:"lunar"};throw new Error("Unknown date format")}function loadEvents(e){var t=localStorage.getItem("scrollPosition");t&&(window.scrollTo(0,parseInt(t,10)),localStorage.removeItem("scrollPosition"));var n,a=JSON.parse(localStorage.getItem("events"))||[];"1"===e?n=getRecommendedEvents(a):"2"===e?n=sortEvents(a):(console.log("当前选择的标签 ID："+getCurrentSelectedTagId()),n=getEventsByTagId(a,e));var o=document.getElementById("cardList");o.innerHTML="",n.futureEvents.forEach(function(e){var t=getGregorianDate(e.event).date;createEventCard(e.event.id,e.event.name,t,e.event.icon,e.event.repeat,getEventDate(e.event).date)}),n.pastEvents.forEach(function(e){var t=getGregorianDate(e.event).date;createEventCard(e.event.id,e.event.name,t,e.event.icon,e.event.repeat,getEventDate(e.event).date)}),o.querySelectorAll(".card").forEach(function(e,t){e.addEventListener("click",function(){var t=document.querySelector("form");t.removeEventListener("input",saveDraftData),t.setAttribute("data-mode","edit"),document.getElementById("add_title").innerText="编辑事件";var n=e.getAttribute("data-row-key");handleCardClick(n);const o=a.find(e=>e.id===n);var r=getGregorianDate(o).date,s=getGregorianDate(o).type;toggleCalendarType(s,new Date("2024-07-08"),document.createElement("div"));const i=new Date(r);fp.setDate(i,!0),selectedDatesInfo={type:s,gregorian:r,lunar:convertToLunar(r)}}),e.addEventListener("mouseover",function(){var t=e.querySelector(".text");t.scrollWidth>t.clientWidth&&t.setAttribute("title",t.innerText)})}),document.querySelectorAll(".more-menu").forEach(function(e,t){var n=document.querySelectorAll(".menu-items")[t];e.addEventListener("click",function(e){e.stopPropagation(),n.classList.toggle("hidden")}),e.addEventListener("mouseenter",function(){n.classList.toggle("hidden")}),e.addEventListener("mouseleave",function(){n.classList.toggle("hidden")})}),document.querySelectorAll(".delete-btn").forEach(function(e){e.addEventListener("click",function(t){t.preventDefault();var n=e.closest(".card"),a=n.getAttribute("data-row-key");deleteEventData(a),loadEvents(getCurrentSelectedTagId())})})}function getRecommendedEvents(e){var t=new Date,n=new Date;n.setDate(t.getDate()+30);var a=new Date;a.setDate(t.getDate()-10);var o=e.filter(e=>{var o=new Date(getEventDate(e).date);return o>=t&&o<=n||o<t&&o>=a});return sortEvents(o)}function getEventsByTagId(e,t){var n=e.filter(e=>{var n=e.tagId.split(",").map(e=>e.trim());return n.includes(t)});return sortEvents(n)}function sortEvents(e){var t=[],n=[];return e.forEach(function(e){var a=getGregorianDate(e).date,o=new Date(a),r=new Date;r.setHours(0,0,0,0);var s=Math.floor((r-o)/864e5);r<o?t.push({event:e,daysRemaining:Math.ceil((o-r)/864e5)}):n.push({event:e,daysPassed:s})}),t.sort(function(e,t){return e.daysRemaining-t.daysRemaining}),n.sort(function(e,t){return e.daysPassed-t.daysPassed}),{futureEvents:t,pastEvents:n}}function createEventCard(e,t,n,a,o,r){var s=document.getElementById("cardList"),i=document.createElement("div"),d=new Date(n);d.setHours(0,0,0,0);var l=new Date;l.setHours(0,0,0,0);let c=localStorage.getItem("showFullDateDifference");console.log(c);var g,u=getDateDifference(d,c);console.log(u);var p=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],m=p[d.getDay()];if(l<d){g=`${r} ${m} 还有`;var v="remaining-days"}else if(l.toDateString()===d.toDateString()){g=`${r} ${m} 今天`;v="remaining-days"}else{g=`${r} ${m} 已过去`;v="passed-days"}i.classList.add("card"),i.setAttribute("data-row-key",e),i.innerHTML=`\n                <div class="image">\n                    ${a}\n                </div>\n                <div class="content">\n                    <div class="event">\n                        <div class="text">${t}</div>\n                        <div class="date">${g}</div>\n                    </div>\n                    <div class="day ${v}">${u}<span class="word">&nbsp;</span></div>\n                    <div id="moreMenu" class="more-menu hidden">\n                    <svg t="1713239999431" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6205" width="20" height="20"><path d="M266.24 440.32a71.68 71.68 0 1 1 0 143.36 71.68 71.68 0 0 1 0-143.36z m491.52 0a71.68 71.68 0 1 1 0 143.36 71.68 71.68 0 0 1 0-143.36z m-245.76 0a71.68 71.68 0 1 1 0 143.36 71.68 71.68 0 0 1 0-143.36z m-245.76 20.48a51.2 51.2 0 1 0 0 102.4 51.2 51.2 0 0 0 0-102.4z m491.52 0a51.2 51.2 0 1 0 0 102.4 51.2 51.2 0 0 0 0-102.4z m-245.76 0a51.2 51.2 0 1 0 0 102.4 51.2 51.2 0 0 0 0-102.4z" fill="#515151" p-id="6206"></path></svg>\n                    <!-- 在这里添加您的菜单项 -->\n                    <div class="menu-items hidden">\n                        <a class="delete-btn" href="#">删除</a>\n                        <!-- <a href="#">菜单项2</a> -->\n                        <!-- 添加更多菜单项 -->\n                    </div>\n                    </div>\n                </div>\n            `,0===u&&i.classList.add("urgent"),s.appendChild(i)}function getCurrentDate(){var e=new Date,t=e.getFullYear(),n=("0"+(e.getMonth()+1)).slice(-2),a=("0"+e.getDate()).slice(-2),o=t+"-"+n+"-"+a;return o}function getDateDifference(e,t){const n=new Date,a=new Date(e);n.setHours(0,0,0,0),a.setHours(0,0,0,0);let o=a<n,r=o?a:n,s=o?n:a;const i=Math.round((s-r)/864e5);if("true"===t){let e=s.getFullYear()-r.getFullYear(),t=s.getMonth()-r.getMonth(),n=s.getDate()-r.getDate();if(n<0){const e=new Date(s.getFullYear(),s.getMonth(),0).getDate();n+=e,t--}t<0&&(t+=12,e--);let a="";return e>0&&(a+=`${e} 年 `),t>0&&(a+=`${t} 月 `),(n>0||0===e&&0===t)&&(a+=`${n} 天`),a.trim()}return`${i} 天`}function updateDateDifference(){const e=showFullDateDifferenceCheckbox.checked;localStorage.setItem("showFullDateDifference",e),loadEvents(getCurrentSelectedTagId())}let selectedDatesInfo={},showGregorian=!0;var previousValue;let fp,showFull;var input=document.getElementById("event-date");let options=[];console.log(options),console.log(typeof options);let selectedOptions=[],highlightedIndex=-1;const dropdownInputContainer=document.getElementById("dropdownInputContainer");let dropdownInput=document.getElementById("dropdownInput");const dropdownOptions=document.getElementById("dropdownOptions"),eventListeners={formInputListeners:[],tagInputListener:null,tagOptionsListener:null,containerClickListener:null};window.onload=function(){window.renderTagsWrapper?window.renderTagsWrapper():console.error("renderTagsWrapper is not defined");var e=chrome.runtime.getManifest().version;if("0.10.14"===e){var t=localStorage.getItem("events"),n=t?JSON.parse(t):[],a=n.every(e=>e.hasOwnProperty("tagId"));a?console.log("All events already have dropdownInput field."):(n=n.map(e=>e.hasOwnProperty("tagId")?e:{...e,tagId:""}),localStorage.setItem("events",JSON.stringify(n)),console.log("Events updated successfully"))}localStorage.getItem("events")?console.log("存在事件数据"):(console.log("空数据"),showEmptyDataMessage());e=chrome.runtime.getManifest().version;var o="更新说明",r="https://github.com/CharlesYe8848/Time-Assistant",s=document.createElement("a");s.setAttribute("class","version-menu-item"),s.setAttribute("href","#"),s.textContent="版本："+e;var i=document.createElement("a");i.setAttribute("class","update-info-menu-item"),i.setAttribute("href","https://mp.weixin.qq.com/s/i8N3OK3ojvgOuxQHoKWPWQ"),i.setAttribute("target","_blank"),i.textContent=o;var d=document.createElement("a");d.setAttribute("class","github-menu-item"),d.setAttribute("href",r),d.setAttribute("target","_blank"),d.textContent="GitHub 地址";var l=document.getElementById("settings-menu");l.appendChild(s),l.appendChild(d),l.appendChild(i);var c=document.getElementById("event-date");const g=document.createElement("div");g.className="lunar-header",g.innerText="";const u=e=>{const t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),o=`${t}-${n}-${a}`,r=Lunar.fromDate(e),s=r.getYearInChinese(),i=r.getMonthInChinese(),d=r.getDayInChinese(),l=`${s}年 ${i}月 ${d}`;selectedDatesInfo={type:showGregorian?"gregorian":"lunar",gregorian:showGregorian?o:"",lunar:showGregorian?"":l}};fp=flatpickr(c,{enableTime:!1,dateFormat:"Y-m-d",defaultDate:new Date,locale:"zh",static:!1,onReady:function(e,t,n){console.log("Datepicker is ready!"),e.length>0&&(u(e[0]),console.log("设置成功"));const a=n.calendarContainer,o=a.querySelector(".flatpickr-months"),r=document.createElement("div");if(r.className="toggle-buttons",r.innerHTML=`\n                            <button id="toggle-gregorian" class="${showGregorian?"active":""}">公历</button>\n                            <button id="toggle-lunar" class="${showGregorian?"":"active"}">农历</button>\n                        `,a.firstChild.insertAdjacentElement("afterend",r),document.getElementById("toggle-gregorian").addEventListener("click",function(){toggleCalendarType("gregorian",e,g)}),document.getElementById("toggle-lunar").addEventListener("click",function(){toggleCalendarType("lunar",e,g)}),o.insertAdjacentElement("afterend",g),showGregorian&&e.length>0){const t=e[0],a=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),s=`${a}-${o}-${r}`;n.input.value=s}else if(!showGregorian&&e.length>0){const t=e[0],a=Lunar.fromDate(t),o=a.getYearInChinese(),r=a.getMonthInChinese(),s=a.getDayInChinese(),i=`${o}年 ${r}月 ${s}`;n.input.value=i}},onDayCreate:function(e,t,n,a){if(!showGregorian){const e=a.dateObj,t=Lunar.fromDate(e);let n=t.getDayInChinese();console.log(t.getMonthInChinese()),"初一"===n&&(n=t.getMonthInChinese()+"月");const o=document.createElement("span");o.className="lunar-date",o.textContent=n,a.appendChild(o),a.addEventListener("mouseenter",function(){const e=t.getYearInChinese(),a=t.getMonthInChinese(),o=`${e}年 ${a}月 ${n}`;g.innerText=`农历: ${o}`}),a.addEventListener("mouseleave",function(){g.innerText=""})}},onChange:function(e,t,n){if(e.length>0){const t=e[0];if(showGregorian){var a=Solar.fromDate(t),o=a.getLunar();console.log(o.toString()),console.log("选择了公历");const e=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0"),i=`${e}-${r}-${s}`;n.input.value=i,selectedDatesInfo={type:"gregorian",gregorian:i,lunar:o.toString()}}else{console.log("选择了农历");const e=Lunar.fromDate(t);console.log("date:"+t),console.log(typeof t);let a=t.getFullYear(),o=(t.getMonth()+1).toString().padStart(2,"0"),r=t.getDate().toString().padStart(2,"0"),s=`${a}-${o}-${r}`;console.log(s),console.log(e.toString());const i=e.getYearInChinese(),d=e.getMonthInChinese();let l=e.getDayInChinese();"初一"===l&&(l=e.getMonthInChinese()+"月");const c=`${i}年 ${d}月 ${l}`;n.input.value=c,selectedDatesInfo={type:"lunar",gregorian:s,lunar:c}}}}}),input.addEventListener("click",function(){console.log("输入框被点击了！"),previousValue=this.value,console.log("previousValue: "+previousValue),fp.open()})},input.addEventListener("keydown",function(e){var t=e.key||e.keyCode;"Backspace"!==t&&"Delete"!==t&&8!==t&&46!==t||e.preventDefault()});var settingsBtn=document.getElementById("settings-btn"),settingsMenu=document.getElementById("settings-menu"),exportOption=document.getElementById("export-btn"),importOption=document.getElementById("import-btn"),addBtn=document.getElementById("add-btn"),backBtn=document.getElementById("back-btn"),contentList=document.getElementById("contentList"),addform=document.getElementById("add-form"),title=document.getElementById("title");const showFullDateDifferenceCheckbox=document.getElementById("showFullDateDifference"),switchLabel=document.querySelector(".dayType");switchLabel.addEventListener("click",()=>{console.log("dianji"),showFullDateDifferenceCheckbox.checked=!showFullDateDifferenceCheckbox.checked,updateDateDifference()}),settingsBtn.addEventListener("click",function(){console.log("settingsBtn"),settingsMenu.classList.contains("hidden")?(settingsMenu.classList.remove("hidden"),settingsMenu.classList.add("show")):(settingsMenu.classList.remove("show"),settingsMenu.classList.add("hidden"));let e=localStorage.getItem("showFullDateDifference");null===e?(e=!0,localStorage.setItem("showFullDateDifference",!0)):e="true"===e,showFullDateDifferenceCheckbox.checked=e,showFullDateDifferenceCheckbox.addEventListener("change",updateDateDifference)}),document.addEventListener("click",function(e){settingsBtn.contains(e.target)||settingsMenu.contains(e.target)||settingsMenu.classList.contains("show")&&(settingsMenu.classList.remove("show"),settingsMenu.classList.add("hidden"))}),document.getElementById("export-btn").addEventListener("click",function(){var e=localStorage.getItem("events");if(e){var t=new Blob([e],{type:"application/json"}),n=document.createElement("a"),a=new Date,o="时间助手-事件备份-"+a.getFullYear()+padZero(a.getMonth()+1)+padZero(a.getDate());n.href=URL.createObjectURL(t),n.download=o+".json",n.click()}else alert("没有可导出的数据");settingsMenu.classList.remove("show"),settingsMenu.classList.add("hidden")}),document.getElementById("import-btn").addEventListener("click",function(){var e=document.createElement("input");e.type="file",e.accept=".json",e.addEventListener("change",function(){var t=e.files[0],n=new FileReader;n.onload=function(){try{var e=JSON.parse(n.result);if(validateJson(e)){var t=localStorage.getItem("events");if(t){var a=JSON.parse(t);a=a.concat(e),localStorage.setItem("events",JSON.stringify(a))}else localStorage.setItem("events",JSON.stringify(e));showMessage("成功导入"+e.length+"个事件"),renderTagsWrapper(!1,getCurrentSelectedTagName()),loadEvents(getCurrentSelectedTagId())}else alert("JSON 格式不正确")}catch(e){alert("文件格式不正确")}},n.readAsText(t)}),e.click(),settingsMenu.classList.remove("show"),settingsMenu.classList.add("hidden")}),addBtn.addEventListener("click",function(){var e=window.scrollY;localStorage.setItem("scrollPosition",e),options=getTags(),settingsBtn.classList.toggle("hidden"),addBtn.classList.toggle("hidden"),contentList.classList.toggle("hidden"),addform.classList.toggle("hidden");var t=document.querySelector("form");t.removeAttribute("pageid");var n=JSON.parse(localStorage.getItem("draftData"));if(n){if(console.log("有草稿"),document.getElementById("event-name").value=n.eventName,selectedDatesInfo=n.eventDate,"gregorian"==n.eventDate.type){document.getElementById("event-date").value=n.eventDate.gregorian,toggleCalendarType("gregorian",new Date("2024-07-08"),document.createElement("div"));const e=new Date(n.eventDate.gregorian);fp.setDate(e,!0)}else{selectedDatesInfo.type="lunar",document.getElementById("event-date").value=n.eventDate.lunar,toggleCalendarType("lunar",new Date("2024-07-08"),document.createElement("div"));const e=new Date(n.eventDate.gregorian);fp.setDate(e,!0)}document.getElementById("icon-svg").value=n.iconSvg,document.getElementById("repeat").value=n.repeat,displayTags()}else{var a=getCurrentDate();document.getElementById("event-name").value="",document.getElementById("event-date").value=a,document.getElementById("icon-svg").value="",document.getElementById("icon-preview").innerHTML="",document.getElementById("repeat").value="none",clearTags()}console.log("点击了添加按钮"),t.setAttribute("data-mode","add"),setupDropdownInputContainerListener(),addEventListeners(t),setupInputListeners()}),document.addEventListener("click",e=>{dropdownInputContainer.contains(e.target)||dropdownOptions.contains(e.target)||(dropdownOptions.style.display="none")}),backBtn.addEventListener("click",function(){console.log("点击了返回按钮"),removeEventListeners(),settingsBtn.classList.toggle("hidden"),addBtn.classList.toggle("hidden"),contentList.classList.toggle("hidden"),addform.classList.toggle("hidden"),document.getElementById("add_title").innerText="添加事件";var e=document.querySelector("form");e.removeAttribute("pageid");var t=localStorage.getItem("scrollPosition");t&&(window.scrollTo(0,parseInt(t,10)),localStorage.removeItem("scrollPosition"))}),document.getElementById("check-btn").addEventListener("click",function(e){e.preventDefault();var t=document.querySelector("form"),n=t.getAttribute("pageid"),a=document.getElementById("event-name").value.trim(),o=document.getElementById("event-date").value.trim(),r=document.getElementById("icon-svg").value.trim(),s=document.getElementById("repeat").value;let i=getSelectedTags();if(""!==a&&""!==o&&""!==r){if(n){var d={id:n,name:a,date:selectedDatesInfo,icon:r,repeat:s,tagId:i};console.log("提交的selectedDatesInfo数据为："+JSON.stringify(selectedDatesInfo)),editEventData(n,d),localStorage.removeItem("draftData")}else console.log("新添加的事件selectedDatesInfo:"+selectedDatesInfo),saveEvent(a,selectedDatesInfo,r,s,i),localStorage.removeItem("draftData"),loadEvents(getCurrentSelectedTagId()),document.getElementById("event-name").value="",document.getElementById("event-date").value=getCurrentDate(),document.getElementById("icon-svg").value="",document.getElementById("icon-preview").innerHTML="",document.getElementById("repeat").value="none",settingsBtn.classList.toggle("hidden"),addBtn.classList.toggle("hidden"),contentList.classList.toggle("hidden"),addform.classList.toggle("hidden");renderTagsWrapper(!1,getCurrentSelectedTagName())}else alert("请填写所有必填字段！")}),document.getElementById("icon-svg").addEventListener("input",function(){var e=document.getElementById("icon-preview"),t=this.value.trim();e.innerHTML=t});const getCurrentSelectedTagId=()=>{const e=document.querySelector(".tag.selected");return e?e.getAttribute("data-id"):null};