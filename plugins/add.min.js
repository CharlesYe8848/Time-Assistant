function toggleCalendarType(e,t,n){if(showGregorian="gregorian"===e,fp&&fp.redraw(),showGregorian)document.getElementById("toggle-gregorian").classList.add("active"),document.getElementById("toggle-lunar").classList.remove("active"),n.innerText="";else if(document.getElementById("toggle-lunar").classList.add("active"),document.getElementById("toggle-gregorian").classList.remove("active"),t.length>0){const e=t[0],a=Lunar.fromDate(e),o=a.getYearInChinese(),r=a.getMonthInChinese(),s=a.getDayInChinese(),i=`${o}年 ${r}月 ${s}`;n.innerText=`农历: ${i}`}}function convertToLunar(e){var t=new Date(e);const n=Lunar.fromDate(t),a=n.getYearInChinese(),o=n.getMonthInChinese(),r=n.getDayInChinese(),s=`${a}年 ${o}月 ${r}日`;return s}function saveDraftData(){var e=document.getElementById("event-name").value.trim(),t=(document.getElementById("event-date").value.trim(),document.getElementById("icon-svg").value.trim()),n=document.getElementById("repeat").value,a={eventName:e,eventDate:selectedDatesInfo,iconSvg:t,repeat:n};localStorage.setItem("draftData",JSON.stringify(a)),console.log("草稿保存了")}function padZero(e){return e<10?"0"+e:e}function validateJson(e){if(Array.isArray(e)){for(var t=0;t<e.length;t++){var n=e[t];if(!(n.hasOwnProperty("id")&&n.hasOwnProperty("name")&&n.hasOwnProperty("icon")&&n.hasOwnProperty("repeat")&&"string"==typeof n.id&&"string"==typeof n.name&&"string"==typeof n.icon&&"string"==typeof n.repeat))return!1;if(!n.hasOwnProperty("date"))return!1;var a=n.date;if("string"==typeof a){if(!isValidDateString(a))return!1}else{if("object"!=typeof a)return!1;if(!a.hasOwnProperty("type")||!a.hasOwnProperty("gregorian")||!a.hasOwnProperty("lunar")||"string"!=typeof a.type||"string"!=typeof a.gregorian||"string"!=typeof a.lunar)return!1}}return!0}return!1}function handleCardClick(e){var t=getEventDataById(e);fillFormWithData(t)}function getEventDataById(e){for(var t=JSON.parse(localStorage.getItem("events"))||[],n=0;n<t.length;n++)if(t[n].id===e)return t[n];return null}function fillFormWithData(e){settingsBtn.classList.toggle("hidden"),addBtn.classList.toggle("hidden"),contentList.classList.toggle("hidden"),addform.classList.toggle("hidden");var t=document.getElementById("event-name"),n=document.getElementById("event-date"),a=document.getElementById("icon-svg"),o=document.getElementById("repeat");t.value=e.name,n.value=getEventDate(e).date,console.log("获取到的日期为："+getEventDate(e).date),a.value=e.icon,o.value=e.repeat;var r=document.querySelector("form");r.setAttribute("pageid",e.id);var s=document.getElementById("icon-preview");s.innerHTML=e.icon}function editEventData(e,t){var n=JSON.parse(localStorage.getItem("events"))||[],a=n.findIndex(function(t){return t.id===e});-1!==a?(console.log(n[a]),console.log(t),n[a]=t,localStorage.setItem("events",JSON.stringify(n)),settingsBtn.classList.toggle("hidden"),addBtn.classList.toggle("hidden"),contentList.classList.toggle("hidden"),addform.classList.toggle("hidden"),loadEvents(),console.log("事件数据已成功编辑并更新到 localStorage 中")):console.error("找不到要编辑的事件数据")}function deleteEventData(e){var t=JSON.parse(localStorage.getItem("events"))||[],n=t.findIndex(function(t){return t.id===e});-1!==n?(t.splice(n,1),0===t.length?localStorage.removeItem("events"):localStorage.setItem("events",JSON.stringify(t)),showMessage("删除成功"),loadEvents(),console.log("事件数据已成功删除并更新到 localStorage 中")):console.error("找不到要删除的事件数据")}function showMessage(e){var t=document.createElement("div");t.textContent=e,t.classList.add("message"),t.style.backgroundColor="white",t.style.boxShadow="0px 0px 10px rgba(0, 0, 0, 0.5)",t.style.width="150px",t.style.height="40px",t.style.lineHeight="40px",t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",document.body.appendChild(t),setTimeout(function(){t.style.opacity="1"},100),setTimeout(function(){t.style.opacity="0"},2e3),setTimeout(function(){document.body.removeChild(t)},2500)}function generateEventId(){return"event_"+Date.now()+"_"+Math.floor(1e3*Math.random())}function saveEvent(e,t,n,a){var o=JSON.parse(localStorage.getItem("events"))||[],r=generateEventId();o.push({id:r,name:e,date:t,icon:n,repeat:a}),localStorage.setItem("events",JSON.stringify(o))}function showEmptyDataMessage(){var e=document.getElementById("cardList");e.innerHTML='\n        <div class="empty-data-message">\n        <svg t="1714992812161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11214" width="32" height="32"><path d="M675.328 117.717333A425.429333 425.429333 0 0 0 512 85.333333C276.352 85.333333 85.333333 276.352 85.333333 512s191.018667 426.666667 426.666667 426.666667 426.666667-191.018667 426.666667-426.666667c0-56.746667-11.093333-112-32.384-163.328a21.333333 21.333333 0 0 0-39.402667 16.341333A382.762667 382.762667 0 0 1 896 512c0 212.074667-171.925333 384-384 384S128 724.074667 128 512 299.925333 128 512 128c51.114667 0 100.8 9.984 146.986667 29.12a21.333333 21.333333 0 0 0 16.341333-39.402667zM533.333333 362.666667a21.333333 21.333333 0 0 0-42.666666 0v170.666666a21.333333 21.333333 0 0 0 6.250666 15.082667l128 128a21.333333 21.333333 0 0 0 30.165334-30.165333L533.333333 524.501333V362.666667z" fill="#707070" p-id="11215"></path></svg>\n            <p>点击 “+” 添加你的重要时刻</p>\n        </div>'}function getEventDate(e){if("string"==typeof e.date)return{date:e.date,type:"gregorian"};if("gregorian"===e.date.type)return{date:e.date.gregorian,type:"gregorian"};if("lunar"===e.date.type)return{date:e.date.lunar,type:"lunar"};throw new Error("Unknown date format")}function getGregorianDate(e){if("string"==typeof e.date)return{date:e.date,type:"gregorian"};if("gregorian"===e.date.type)return{date:e.date.gregorian,type:"gregorian"};if("lunar"===e.date.type)return{date:e.date.gregorian,type:"lunar"};throw new Error("Unknown date format")}function loadEvents(){var e=JSON.parse(localStorage.getItem("events"))||[],t=sortEvents(e),n=document.getElementById("cardList");n.innerHTML="",t.futureEvents.forEach(function(e){var t=getGregorianDate(e.event).date;createEventCard(e.event.id,e.event.name,t,e.event.icon,e.event.repeat,getEventDate(e.event).date)}),t.pastEvents.forEach(function(e){var t=getGregorianDate(e.event).date;createEventCard(e.event.id,e.event.name,t,e.event.icon,e.event.repeat,getEventDate(e.event).date)});n=document.getElementById("cardList");var a=n.querySelectorAll(".card");a.forEach(function(t,n){t.addEventListener("click",function(){console.log("点击了卡片 "+(n+1));var a=document.querySelector("form");a.removeEventListener("input",saveDraftData),document.getElementById("add_title").innerText="编辑事件";var o=t.getAttribute("data-row-key");handleCardClick(o);const r=e.find(e=>e.id===o);var s=getGregorianDate(r).date,i=getGregorianDate(r).type;console.log(document.getElementById("event-date").value.trim()),console.log("公历日期为："+s),console.log("日期类型："+i),toggleCalendarType(i,new Date("2024-07-08"),document.createElement("div"));const l=new Date(s);fp.setDate(l,!0),selectedDatesInfo={type:i,gregorian:s,lunar:convertToLunar(s)},console.log("点击进来的selectedDatesInfo数据为："+JSON.stringify(selectedDatesInfo)),a.addEventListener("input",saveDraftData)}),t.addEventListener("mouseover",function(){console.log("鼠标悬停在卡片 "+(n+1));var e=t.querySelector(".text");console.log(e.scrollWidth),console.log(e.clientWidth),e.scrollWidth>e.clientWidth&&(console.log("进来啦"),e.setAttribute("title",e.innerText))})});var o=document.querySelectorAll(".more-menu"),r=document.querySelectorAll(".menu-items");o.forEach(function(e,t){e.addEventListener("click",function(e){e.stopPropagation(),console.log("点击了更多菜单 "+(t+1));var n=r[t];console.log(n),n.classList.toggle("hidden")}),e.addEventListener("mouseenter",function(){var e=r[t];e.classList.toggle("hidden")}),e.addEventListener("mouseleave",function(){var e=r[t];e.classList.toggle("hidden")})});var s=document.querySelectorAll(".delete-btn");s.forEach(function(e){e.addEventListener("click",function(t){t.preventDefault();var n=e.closest(".card");console.log("最近的card："+n);var a=n.getAttribute("data-row-key");console.log("card的索引为："+a),deleteEventData(a),loadEvents()})})}function sortEvents(e){var t=[],n=[];return e.forEach(function(e){var a=getGregorianDate(e).date,o=new Date(a),r=new Date;r.setHours(0,0,0,0);var s=Math.floor((r-o)/864e5);r<o?t.push({event:e,daysRemaining:Math.ceil((o-r)/864e5)}):n.push({event:e,daysPassed:s})}),t.sort(function(e,t){return e.daysRemaining-t.daysRemaining}),n.sort(function(e,t){return e.daysPassed-t.daysPassed}),{futureEvents:t,pastEvents:n}}function createEventCard(e,t,n,a,o,r){var s=document.getElementById("cardList"),i=document.createElement("div"),l=new Date(n);l.setHours(0,0,0,0);var d=new Date;d.setHours(0,0,0,0);var c,g=Math.floor((d-l)/864e5),u=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],v=u[l.getDay()];if(d<l){var m=Math.ceil((l-d)/864e5);g=m;c=`${r} ${v} 还有`;var f="remaining-days"}else if(d.toDateString()===l.toDateString()){c=`${r} ${v} 今天`;f="remaining-days"}else{c=`${r} ${v} 已过去`;f="passed-days"}i.classList.add("card"),i.setAttribute("data-row-key",e),i.innerHTML=`\n                <div class="image">\n                    ${a}\n                </div>\n                <div class="content">\n                    <div class="event">\n                        <div class="text">${t}</div>\n                        <div class="date">${c}</div>\n                    </div>\n                    <div class="day ${f}">${g}<span class="word">&nbsp;天</span></div>\n                    <div id="moreMenu" class="more-menu hidden">\n                    <svg t="1713239999431" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6205" width="20" height="20"><path d="M266.24 440.32a71.68 71.68 0 1 1 0 143.36 71.68 71.68 0 0 1 0-143.36z m491.52 0a71.68 71.68 0 1 1 0 143.36 71.68 71.68 0 0 1 0-143.36z m-245.76 0a71.68 71.68 0 1 1 0 143.36 71.68 71.68 0 0 1 0-143.36z m-245.76 20.48a51.2 51.2 0 1 0 0 102.4 51.2 51.2 0 0 0 0-102.4z m491.52 0a51.2 51.2 0 1 0 0 102.4 51.2 51.2 0 0 0 0-102.4z m-245.76 0a51.2 51.2 0 1 0 0 102.4 51.2 51.2 0 0 0 0-102.4z" fill="#515151" p-id="6206"></path></svg>\n                    <!-- 在这里添加您的菜单项 -->\n                    <div class="menu-items hidden">\n                        <a class="delete-btn" href="#">删除</a>\n                        <!-- <a href="#">菜单项2</a> -->\n                        <!-- 添加更多菜单项 -->\n                    </div>\n                    </div>\n                </div>\n            `,0===g&&i.classList.add("urgent"),s.appendChild(i)}function getCurrentDate(){var e=new Date,t=e.getFullYear(),n=("0"+(e.getMonth()+1)).slice(-2),a=("0"+e.getDate()).slice(-2),o=t+"-"+n+"-"+a;return o}let selectedDatesInfo={},showGregorian=!0;var previousValue;let fp;var input=document.getElementById("event-date");window.onload=function(){localStorage.getItem("events")?loadEvents():(console.log("空数据"),showEmptyDataMessage());var e=chrome.runtime.getManifest().version,t="更新说明",n=document.createElement("a");n.setAttribute("class","version-menu-item"),n.setAttribute("href","#"),n.textContent="版本："+e;var a=document.createElement("a");a.setAttribute("class","update-info-menu-item"),a.setAttribute("href","https://mp.weixin.qq.com/s/i8N3OK3ojvgOuxQHoKWPWQ"),a.setAttribute("target","_blank"),a.textContent=t;var o=document.getElementById("settings-menu");o.appendChild(n),o.appendChild(a);var r=document.getElementById("event-date");const s=document.createElement("div");s.className="lunar-header",s.innerText="";const i=e=>{const t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),o=`${t}-${n}-${a}`,r=Lunar.fromDate(e),s=r.getYearInChinese(),i=r.getMonthInChinese(),l=r.getDayInChinese(),d=`${s}年 ${i}月 ${l}`;selectedDatesInfo={type:showGregorian?"gregorian":"lunar",gregorian:showGregorian?o:"",lunar:showGregorian?"":d}};fp=flatpickr(r,{enableTime:!1,dateFormat:"Y-m-d",defaultDate:new Date,locale:"zh",static:!1,onReady:function(e,t,n){console.log("Datepicker is ready!"),e.length>0&&(i(e[0]),console.log("设置成功"));const a=n.calendarContainer,o=a.querySelector(".flatpickr-months"),r=document.createElement("div");if(r.className="toggle-buttons",r.innerHTML=`\n                            <button id="toggle-gregorian" class="${showGregorian?"active":""}">公历</button>\n                            <button id="toggle-lunar" class="${showGregorian?"":"active"}">农历</button>\n                        `,a.firstChild.insertAdjacentElement("afterend",r),document.getElementById("toggle-gregorian").addEventListener("click",function(){toggleCalendarType("gregorian",e,s)}),document.getElementById("toggle-lunar").addEventListener("click",function(){toggleCalendarType("lunar",e,s)}),o.insertAdjacentElement("afterend",s),showGregorian&&e.length>0){const t=e[0],a=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),s=`${a}-${o}-${r}`;n.input.value=s}else if(!showGregorian&&e.length>0){const t=e[0],a=Lunar.fromDate(t),o=a.getYearInChinese(),r=a.getMonthInChinese(),s=a.getDayInChinese(),i=`${o}年 ${r}月 ${s}`;n.input.value=i}},onDayCreate:function(e,t,n,a){if(!showGregorian){const e=a.dateObj,t=Lunar.fromDate(e);let n=t.getDayInChinese();console.log(t.getMonthInChinese()),"初一"===n&&(n=t.getMonthInChinese()+"月");const o=document.createElement("span");o.className="lunar-date",o.textContent=n,a.appendChild(o),a.addEventListener("mouseenter",function(){const e=t.getYearInChinese(),a=t.getMonthInChinese(),o=`${e}年 ${a}月 ${n}`;s.innerText=`农历: ${o}`}),a.addEventListener("mouseleave",function(){s.innerText=""})}},onChange:function(e,t,n){if(e.length>0){const t=e[0];if(showGregorian){var a=Solar.fromDate(t),o=a.getLunar();console.log(o.toString()),console.log("选择了公历");const e=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0"),i=`${e}-${r}-${s}`;n.input.value=i,selectedDatesInfo={type:"gregorian",gregorian:i,lunar:o.toString()}}else{console.log("选择了农历");const e=Lunar.fromDate(t);console.log("date:"+t),console.log(typeof t);let a=t.getFullYear(),o=(t.getMonth()+1).toString().padStart(2,"0"),r=t.getDate().toString().padStart(2,"0"),s=`${a}-${o}-${r}`;console.log(s),console.log(e.toString());const i=e.getYearInChinese(),l=e.getMonthInChinese();let d=e.getDayInChinese();"初一"===d&&(d=e.getMonthInChinese()+"月");const c=`${i}年 ${l}月 ${d}`;n.input.value=c,selectedDatesInfo={type:"lunar",gregorian:s,lunar:c}}}}}),input.addEventListener("click",function(){console.log("输入框被点击了！"),previousValue=this.value,console.log("previousValue: "+previousValue),fp.open()})},input.addEventListener("keydown",function(e){var t=e.key||e.keyCode;"Backspace"!==t&&"Delete"!==t&&8!==t&&46!==t||e.preventDefault()});var settingsBtn=document.getElementById("settings-btn"),settingsMenu=document.getElementById("settings-menu"),exportOption=document.getElementById("export-btn"),importOption=document.getElementById("import-btn"),addBtn=document.getElementById("add-btn"),backBtn=document.getElementById("back-btn"),contentList=document.getElementById("contentList"),addform=document.getElementById("add-form"),title=document.getElementById("title");settingsBtn.addEventListener("click",function(){console.log("settingsBtn"),settingsMenu.classList.contains("hidden")?(settingsMenu.classList.remove("hidden"),settingsMenu.classList.add("show")):(settingsMenu.classList.remove("show"),settingsMenu.classList.add("hidden"))}),document.addEventListener("click",function(e){settingsBtn.contains(e.target)||settingsMenu.contains(e.target)||settingsMenu.classList.contains("show")&&(settingsMenu.classList.remove("show"),settingsMenu.classList.add("hidden"))}),document.getElementById("export-btn").addEventListener("click",function(){var e=localStorage.getItem("events");if(e){var t=new Blob([e],{type:"application/json"}),n=document.createElement("a"),a=new Date,o="时间助手-事件备份-"+a.getFullYear()+padZero(a.getMonth()+1)+padZero(a.getDate());n.href=URL.createObjectURL(t),n.download=o+".json",n.click()}else alert("没有可导出的数据");settingsMenu.classList.remove("show"),settingsMenu.classList.add("hidden")}),document.getElementById("import-btn").addEventListener("click",function(){var e=document.createElement("input");e.type="file",e.accept=".json",e.addEventListener("change",function(){var t=e.files[0],n=new FileReader;n.onload=function(){try{var e=JSON.parse(n.result);if(validateJson(e)){var t=localStorage.getItem("events");if(t){var a=JSON.parse(t);a=a.concat(e),localStorage.setItem("events",JSON.stringify(a))}else localStorage.setItem("events",JSON.stringify(e));showMessage("成功导入"+e.length+"个事件"),loadEvents()}else alert("JSON 格式不正确")}catch(e){alert("文件格式不正确")}},n.readAsText(t)}),e.click(),settingsMenu.classList.remove("show"),settingsMenu.classList.add("hidden")}),addBtn.addEventListener("click",function(){settingsBtn.classList.toggle("hidden"),addBtn.classList.toggle("hidden"),contentList.classList.toggle("hidden"),addform.classList.toggle("hidden");var e=document.querySelector("form");e.removeAttribute("pageid");var t=JSON.parse(localStorage.getItem("draftData"));if(t){if(document.getElementById("event-name").value=t.eventName,selectedDatesInfo=t.eventDate,"gregorian"==t.eventDate.type){document.getElementById("event-date").value=t.eventDate.gregorian,toggleCalendarType("gregorian",new Date("2024-07-08"),document.createElement("div"));const e=new Date(t.eventDate.gregorian);fp.setDate(e,!0)}else{selectedDatesInfo.type="lunar",document.getElementById("event-date").value=t.eventDate.lunar,toggleCalendarType("lunar",new Date("2024-07-08"),document.createElement("div"));const e=new Date(t.eventDate.gregorian);fp.setDate(e,!0)}document.getElementById("icon-svg").value=t.iconSvg,document.getElementById("repeat").value=t.repeat}else{var n=getCurrentDate();document.getElementById("event-name").value="",document.getElementById("event-date").value=n,document.getElementById("icon-svg").value="",document.getElementById("icon-preview").innerHTML="",document.getElementById("repeat").value="none"}console.log("点击了添加按钮"),e.addEventListener("input",saveDraftData)}),backBtn.addEventListener("click",function(){settingsBtn.classList.toggle("hidden"),addBtn.classList.toggle("hidden"),contentList.classList.toggle("hidden"),addform.classList.toggle("hidden"),document.getElementById("add_title").innerText="添加事件";var e=document.querySelector("form");e.removeAttribute("pageid")}),document.getElementById("check-btn").addEventListener("click",function(e){e.preventDefault();var t=document.querySelector("form"),n=t.getAttribute("pageid"),a=document.getElementById("event-name").value.trim(),o=document.getElementById("event-date").value.trim(),r=document.getElementById("icon-svg").value.trim(),s=document.getElementById("repeat").value;if(""!==a&&""!==o&&""!==r)if(n){var i={id:n,name:a,date:selectedDatesInfo,icon:r,repeat:s};console.log("提交的selectedDatesInfo数据为："+JSON.stringify(selectedDatesInfo)),editEventData(n,i),localStorage.removeItem("draftData")}else console.log("新添加的事件selectedDatesInfo:"+selectedDatesInfo),saveEvent(a,selectedDatesInfo,r,s),localStorage.removeItem("draftData"),loadEvents(),document.getElementById("event-name").value="",document.getElementById("event-date").value=getCurrentDate(),document.getElementById("icon-svg").value="",document.getElementById("icon-preview").innerHTML="",document.getElementById("repeat").value="none",settingsBtn.classList.toggle("hidden"),addBtn.classList.toggle("hidden"),contentList.classList.toggle("hidden"),addform.classList.toggle("hidden");else alert("请填写所有必填字段！")}),document.getElementById("icon-svg").addEventListener("input",function(){var e=document.getElementById("icon-preview"),t=this.value.trim();e.innerHTML=t});