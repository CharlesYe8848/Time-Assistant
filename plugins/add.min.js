function saveDraftData(){var e=document.getElementById("event-name").value.trim(),t=document.getElementById("event-date").value.trim(),n=document.getElementById("icon-svg").value.trim(),a=document.getElementById("repeat").value,s={eventName:e,eventDate:t,iconSvg:n,repeat:a};localStorage.setItem("draftData",JSON.stringify(s))}function padZero(e){return e<10?"0"+e:e}function validateJson(e){if(Array.isArray(e)){for(var t=0;t<e.length;t++){var n=e[t];if(!(n.hasOwnProperty("id")&&n.hasOwnProperty("name")&&n.hasOwnProperty("date")&&n.hasOwnProperty("icon")&&n.hasOwnProperty("repeat")&&"string"==typeof n.id&&"string"==typeof n.name&&"string"==typeof n.date&&"string"==typeof n.icon&&"string"==typeof n.repeat))return!1}return!0}return!1}function handleCardClick(e){var t=getEventDataById(e);fillFormWithData(t)}function getEventDataById(e){for(var t=JSON.parse(localStorage.getItem("events"))||[],n=0;n<t.length;n++)if(t[n].id===e)return t[n];return null}function fillFormWithData(e){settingsBtn.classList.toggle("hidden"),addBtn.classList.toggle("hidden"),contentList.classList.toggle("hidden"),addform.classList.toggle("hidden");var t=document.getElementById("event-name"),n=document.getElementById("event-date"),a=document.getElementById("icon-svg"),s=document.getElementById("repeat");t.value=e.name,n.value=e.date,a.value=e.icon,s.value=e.repeat;var o=document.querySelector("form");o.setAttribute("pageid",e.id);var i=document.getElementById("icon-preview");i.innerHTML=e.icon}function editEventData(e,t){var n=JSON.parse(localStorage.getItem("events"))||[],a=n.findIndex(function(t){return t.id===e});-1!==a?(console.log(n[a]),console.log(t),n[a]=t,localStorage.setItem("events",JSON.stringify(n)),settingsBtn.classList.toggle("hidden"),addBtn.classList.toggle("hidden"),contentList.classList.toggle("hidden"),addform.classList.toggle("hidden"),loadEvents(),console.log("事件数据已成功编辑并更新到 localStorage 中")):console.error("找不到要编辑的事件数据")}function deleteEventData(e){var t=JSON.parse(localStorage.getItem("events"))||[],n=t.findIndex(function(t){return t.id===e});-1!==n?(t.splice(n,1),0===t.length?localStorage.removeItem("events"):localStorage.setItem("events",JSON.stringify(t)),showMessage("删除成功"),loadEvents(),console.log("事件数据已成功删除并更新到 localStorage 中")):console.error("找不到要删除的事件数据")}function showMessage(e){var t=document.createElement("div");t.textContent=e,t.classList.add("message"),t.style.backgroundColor="white",t.style.boxShadow="0px 0px 10px rgba(0, 0, 0, 0.5)",t.style.width="150px",t.style.height="40px",t.style.lineHeight="40px",t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",document.body.appendChild(t),setTimeout(function(){t.style.opacity="1"},100),setTimeout(function(){t.style.opacity="0"},2e3),setTimeout(function(){document.body.removeChild(t)},2500)}function generateEventId(){return"event_"+Date.now()+"_"+Math.floor(1e3*Math.random())}function saveEvent(e,t,n,a){var s=JSON.parse(localStorage.getItem("events"))||[],o=generateEventId();s.push({id:o,name:e,date:t,icon:n,repeat:a}),localStorage.setItem("events",JSON.stringify(s))}function showEmptyDataMessage(){var e=document.getElementById("cardList");e.innerHTML='\n        <div class="empty-data-message">\n        <svg t="1714992812161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11214" width="32" height="32"><path d="M675.328 117.717333A425.429333 425.429333 0 0 0 512 85.333333C276.352 85.333333 85.333333 276.352 85.333333 512s191.018667 426.666667 426.666667 426.666667 426.666667-191.018667 426.666667-426.666667c0-56.746667-11.093333-112-32.384-163.328a21.333333 21.333333 0 0 0-39.402667 16.341333A382.762667 382.762667 0 0 1 896 512c0 212.074667-171.925333 384-384 384S128 724.074667 128 512 299.925333 128 512 128c51.114667 0 100.8 9.984 146.986667 29.12a21.333333 21.333333 0 0 0 16.341333-39.402667zM533.333333 362.666667a21.333333 21.333333 0 0 0-42.666666 0v170.666666a21.333333 21.333333 0 0 0 6.250666 15.082667l128 128a21.333333 21.333333 0 0 0 30.165334-30.165333L533.333333 524.501333V362.666667z" fill="#707070" p-id="11215"></path></svg>\n            <p>点击 “+” 添加你的重要时刻</p>\n        </div>'}function loadEvents(){var e=JSON.parse(localStorage.getItem("events"))||[],t=sortEvents(e),n=document.getElementById("cardList");n.innerHTML="",t.futureEvents.forEach(function(e){createEventCard(e.event.id,e.event.name,e.event.date,e.event.icon,e.event.repeat)}),t.pastEvents.forEach(function(e){createEventCard(e.event.id,e.event.name,e.event.date,e.event.icon,e.event.repeat)});n=document.getElementById("cardList");var a=n.querySelectorAll(".card");a.forEach(function(e,t){e.addEventListener("click",function(n){console.log("点击了卡片 "+(t+1)),document.getElementById("add_title").innerText="编辑事件";var a=e.getAttribute("data-row-key");handleCardClick(a)}),e.addEventListener("mouseover",function(n){console.log("鼠标悬停在卡片 "+(t+1));var a=e.querySelector(".text");console.log(a.scrollWidth),console.log(a.clientWidth),a.scrollWidth>a.clientWidth&&(console.log("进来啦"),a.setAttribute("title",a.innerText))})});var s=document.querySelectorAll(".more-menu"),o=document.querySelectorAll(".menu-items");s.forEach(function(e,t){e.addEventListener("click",function(e){e.stopPropagation(),console.log("点击了更多菜单 "+(t+1));var n=o[t];console.log(n),n.classList.toggle("hidden")}),e.addEventListener("mouseenter",function(e){var n=o[t];n.classList.toggle("hidden")}),e.addEventListener("mouseleave",function(e){var n=o[t];n.classList.toggle("hidden")})});var i=document.querySelectorAll(".delete-btn");i.forEach(function(e){e.addEventListener("click",function(t){t.preventDefault();var n=e.closest(".card");console.log("最近的card："+n);var a=n.getAttribute("data-row-key");console.log("card的索引为："+a),deleteEventData(a),loadEvents()})})}function sortEvents(e){var t=[],n=[];return e.forEach(function(e){var a=new Date(e.date),s=new Date;s.setHours(0,0,0,0);var o=Math.floor((s-a)/864e5);s<a?t.push({event:e,daysRemaining:Math.ceil((a-s)/864e5)}):n.push({event:e,daysPassed:o})}),t.sort(function(e,t){return e.daysRemaining-t.daysRemaining}),n.sort(function(e,t){return e.daysPassed-t.daysPassed}),{futureEvents:t,pastEvents:n}}function createEventCard(e,t,n,a,s){var o=document.getElementById("cardList"),i=document.createElement("div"),d=new Date(n);d.setHours(0,0,0,0);var l=new Date;l.setHours(0,0,0,0);var r,c=Math.floor((l-d)/864e5),u=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],g=u[d.getDay()];if(l<d){var v=Math.ceil((d-l)/864e5);c=v;r=`${n} ${g} 还有`;var m="remaining-days"}else if(l.toDateString()===d.toDateString()){r=`${n} ${g} 今天`;m="remaining-days"}else{r=`${n} ${g} 已过去`;m="passed-days"}i.classList.add("card"),i.setAttribute("data-row-key",e),i.innerHTML=`\n                <div class="image">\n                    ${a}\n                </div>\n                <div class="content">\n                    <div class="event">\n                        <div class="text">${t}</div>\n                        <div class="date">${r}</div>\n                    </div>\n                    <div class="day ${m}">${c}<span class="word">&nbsp;天</span></div>\n                    <div id="moreMenu" class="more-menu hidden">\n                    <svg t="1713239999431" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6205" width="20" height="20"><path d="M266.24 440.32a71.68 71.68 0 1 1 0 143.36 71.68 71.68 0 0 1 0-143.36z m491.52 0a71.68 71.68 0 1 1 0 143.36 71.68 71.68 0 0 1 0-143.36z m-245.76 0a71.68 71.68 0 1 1 0 143.36 71.68 71.68 0 0 1 0-143.36z m-245.76 20.48a51.2 51.2 0 1 0 0 102.4 51.2 51.2 0 0 0 0-102.4z m491.52 0a51.2 51.2 0 1 0 0 102.4 51.2 51.2 0 0 0 0-102.4z m-245.76 0a51.2 51.2 0 1 0 0 102.4 51.2 51.2 0 0 0 0-102.4z" fill="#515151" p-id="6206"></path></svg>\n                    <!-- 在这里添加您的菜单项 -->\n                    <div class="menu-items hidden">\n                        <a class="delete-btn" href="#">删除</a>\n                        <!-- <a href="#">菜单项2</a> -->\n                        <!-- 添加更多菜单项 -->\n                    </div>\n                    </div>\n                </div>\n            `,0===c&&i.classList.add("urgent"),o.appendChild(i)}function getCurrentDate(){var e=new Date,t=e.getFullYear(),n=("0"+(e.getMonth()+1)).slice(-2),a=("0"+e.getDate()).slice(-2),s=t+"-"+n+"-"+a;return s}var previousValue;window.onload=function(){localStorage.getItem("events")?loadEvents():(console.log("空数据"),showEmptyDataMessage());var e=document.getElementById("event-date");flatpickr(e,{enableTime:!1,dateFormat:"Y-m-d",locale:"zh",static:!1});var t=chrome.runtime.getManifest().version,n="更新说明",a=document.createElement("a");a.setAttribute("class","version-menu-item"),a.setAttribute("href","#"),a.textContent="版本："+t;var s=document.createElement("a");s.setAttribute("class","update-info-menu-item"),s.setAttribute("href","https://mp.weixin.qq.com/s/i8N3OK3ojvgOuxQHoKWPWQ"),s.setAttribute("target","_blank"),s.textContent=n;var o=document.getElementById("settings-menu");o.appendChild(a),o.appendChild(s)},document.getElementById("event-date").addEventListener("click",function(e){console.log("输入框被点击了！"),previousValue=this.value,console.log("previousValue: "+previousValue)}),document.getElementById("event-date").addEventListener("input",function(e){void 0!==previousValue&&(this.value.length<previousValue.length?(this.value=previousValue,console.log("恢复之前的内容了！"),console.log("previousValue: "+previousValue)):previousValue=this.value)});var settingsBtn=document.getElementById("settings-btn"),settingsMenu=document.getElementById("settings-menu"),exportOption=document.getElementById("export-btn"),importOption=document.getElementById("import-btn"),addBtn=document.getElementById("add-btn"),backBtn=document.getElementById("back-btn"),contentList=document.getElementById("contentList"),addform=document.getElementById("add-form"),title=document.getElementById("title");settingsBtn.addEventListener("click",function(){console.log("settingsBtn"),settingsMenu.classList.contains("hidden")?(settingsMenu.classList.remove("hidden"),settingsMenu.classList.add("show")):(settingsMenu.classList.remove("show"),settingsMenu.classList.add("hidden"))}),document.addEventListener("click",function(e){settingsBtn.contains(e.target)||settingsMenu.contains(e.target)||settingsMenu.classList.contains("show")&&(settingsMenu.classList.remove("show"),settingsMenu.classList.add("hidden"))}),document.getElementById("export-btn").addEventListener("click",function(){var e=localStorage.getItem("events");if(e){var t=new Blob([e],{type:"application/json"}),n=document.createElement("a"),a=new Date,s="时间助手-事件备份-"+a.getFullYear()+padZero(a.getMonth()+1)+padZero(a.getDate());n.href=URL.createObjectURL(t),n.download=s+".json",n.click()}else alert("没有可导出的数据");settingsMenu.classList.remove("show"),settingsMenu.classList.add("hidden")}),document.getElementById("import-btn").addEventListener("click",function(){var e=document.createElement("input");e.type="file",e.accept=".json",e.addEventListener("change",function(){var t=e.files[0],n=new FileReader;n.onload=function(){try{var e=JSON.parse(n.result);if(validateJson(e)){var t=localStorage.getItem("events");if(t){var a=JSON.parse(t);a=a.concat(e),localStorage.setItem("events",JSON.stringify(a))}else localStorage.setItem("events",JSON.stringify(e));showMessage("成功导入"+e.length+"个事件"),loadEvents()}else alert("JSON 格式不正确")}catch(e){alert("文件格式不正确")}},n.readAsText(t)}),e.click(),settingsMenu.classList.remove("show"),settingsMenu.classList.add("hidden")}),addBtn.addEventListener("click",function(){settingsBtn.classList.toggle("hidden"),addBtn.classList.toggle("hidden"),contentList.classList.toggle("hidden"),addform.classList.toggle("hidden");var e=document.querySelector("form");e.removeAttribute("pageid");var t=JSON.parse(localStorage.getItem("draftData"));if(t)document.getElementById("event-name").value=t.eventName,document.getElementById("event-date").value=t.eventDate,document.getElementById("icon-svg").value=t.iconSvg,document.getElementById("repeat").value=t.repeat;else{var n=getCurrentDate();document.getElementById("event-name").value="",document.getElementById("event-date").value=n,document.getElementById("icon-svg").value="",document.getElementById("icon-preview").innerHTML="",document.getElementById("repeat").value="none"}document.getElementById("add-form").addEventListener("input",saveDraftData)}),backBtn.addEventListener("click",function(){settingsBtn.classList.toggle("hidden"),addBtn.classList.toggle("hidden"),contentList.classList.toggle("hidden"),addform.classList.toggle("hidden"),document.getElementById("add_title").innerText="添加事件";var e=document.querySelector("form");e.removeAttribute("pageid")}),document.getElementById("check-btn").addEventListener("click",function(e){e.preventDefault();var t=document.querySelector("form"),n=t.getAttribute("pageid"),a=document.getElementById("event-name").value.trim(),s=document.getElementById("event-date").value.trim(),o=document.getElementById("icon-svg").value.trim(),i=document.getElementById("repeat").value;if(""!==a&&""!==s&&""!==o)if(n){var d={id:n,name:a,date:s,icon:o,repeat:i};editEventData(n,d)}else localStorage.removeItem("draftData"),saveEvent(a,s,o,i),loadEvents(),document.getElementById("event-name").value="",document.getElementById("event-date").value=getCurrentDate(),document.getElementById("icon-svg").value="",document.getElementById("icon-preview").innerHTML="",document.getElementById("repeat").value="none",settingsBtn.classList.toggle("hidden"),addBtn.classList.toggle("hidden"),contentList.classList.toggle("hidden"),addform.classList.toggle("hidden");else alert("请填写所有必填字段！")}),document.getElementById("icon-svg").addEventListener("input",function(){var e=document.getElementById("icon-preview"),t=this.value.trim();e.innerHTML=t});