document.addEventListener("DOMContentLoaded",()=>{function e(){document.body.style.overflow="hidden"}function t(){document.body.style.overflow="auto"}const n=[{id:"1",name:"推荐",order:1},{id:"2",name:"全部",order:2}];localStorage.getItem("tags")&&0!==JSON.parse(localStorage.getItem("tags")).length||localStorage.setItem("tags",JSON.stringify(n));const a=()=>{const e=JSON.parse(localStorage.getItem("tags"))||[];return e.sort((e,t)=>e.order-t.order)},o=e=>{localStorage.setItem("tags",JSON.stringify(e))},s=e=>{const t=JSON.parse(localStorage.getItem("events"))||[];return"2"===e?t.length:"1"===e?getRecommendedEvents(t).futureEvents.length+getRecommendedEvents(t).pastEvents.length:t.filter(t=>{const n=t.tagId.split(",").map(e=>e.trim());return n.includes(e)}).length},l=(e=!1,t=null)=>{console.log("Start renderTagsWrapper",{isInitialLoad:e,currentSelectedTagName:t});const n=document.getElementById("tags-wrapper"),o=n.querySelector(".tag.selected"),l=o?o.textContent.split(" ")[0]:null;console.log("Existing selected tag:",l),n.innerHTML="";const d=a();console.log("Tags:",d),d.forEach((a,o)=>{console.log(`Rendering tag: ${a.name}, Index: ${o}`);const d=document.createElement("div");d.className="tag unselected",d.textContent=`${a.name} ${s(a.id)}`,d.setAttribute("data-id",a.id),(e&&0===o||a.name===l||a.name===t)&&(console.log(`Selecting tag: ${a.name}`),d.classList.add("selected"),d.classList.remove("unselected")),n.appendChild(d),console.log(`Appended tag: ${a.name}, Classes: ${d.className}`),d.addEventListener("click",function(){console.log("Tag clicked:",this.textContent),document.querySelectorAll(".tag").forEach(e=>{e.classList.remove("selected"),e.classList.add("unselected")}),this.classList.add("selected"),this.classList.remove("unselected");const e=this.offsetLeft-(n.clientWidth/2-this.clientWidth/2);n.scroll({left:e,behavior:"smooth"}),loadEvents(this.getAttribute("data-id")),console.log("After click, selected tag:",document.querySelector(".tag.selected").textContent)})}),e&&d.length>0&&(console.log(`Loading events for first tag: ${d[0].name}`),loadEvents(d[0].id)),console.log("End renderTagsWrapper")};l(!0);const d=()=>{const e=document.querySelector(".tag.selected");return e?e.textContent.split(" ")[0]:null},c=()=>{e(),document.getElementById("tagManagementModal").style.display="block",r()},i=()=>{t(),document.getElementById("tagManagementModal").style.display="none"};document.querySelector(".menu-icon").addEventListener("click",c),document.querySelector(".close").addEventListener("click",i);const r=()=>{const e=document.querySelector(".tags-list");e.innerHTML="";const t=a();t.forEach((t,n)=>{const a=document.createElement("div");a.className="tag-item",a.draggable=!0;const o=document.createElement("span");o.className="drag-handle",o.innerText="☰";const l=document.createElement("div");l.style.position="relative";const d=document.createElement("input");d.type="text",d.value=t.name,d.className="tag-name-input",d.disabled="推荐"===t.name||"全部"===t.name,d.onchange=(()=>m(t.id,d.value,d));const c=document.createElement("div");c.className="red-text",c.style.display="none",l.appendChild(d),l.appendChild(c);const i=document.createElement("button");i.innerText="删除",i.className="delete-button","推荐"===t.name||"全部"===t.name?(i.classList.add("disabled"),i.disabled=!0):i.addEventListener("click",()=>{const e=s(t.id);e>0?alert("当前标签下面存在"+e+"个事件，暂时不支持删除"):u(t.id)}),a.appendChild(o),a.appendChild(l),a.appendChild(i),e.appendChild(a),a.addEventListener("dragstart",e=>{e.dataTransfer.setData("text/plain",t.id),e.target.classList.add("dragging")}),a.addEventListener("dragover",e=>{e.preventDefault();const t=document.querySelector(".dragging"),n=e.clientY-a.getBoundingClientRect().top>a.clientHeight/2;n?a.parentNode.insertBefore(t,a.nextSibling):a.parentNode.insertBefore(t,a)}),a.addEventListener("dragend",e=>{e.target.classList.remove("dragging");const t=[...document.querySelectorAll(".tag-item input")].map(e=>e.value);v(t)})})},g=e=>{const t=document.getElementById("tip-message");t.textContent=e,t.style.display="block",t.style.opacity="1",setTimeout(()=>{t.style.transition="opacity 1s",t.style.opacity="0",setTimeout(()=>{t.style.display="none",t.style.transition=""},1e3)},2e3)},m=(e,t,n)=>{const s=a(),c=s.findIndex(t=>t.id===e);if(-1!==c){if(s.some(e=>e.name===t))return n.nextElementSibling.style.display="block",n.nextElementSibling.textContent="标签已存在，请重新填写",void g("标签已存在，请重新填写");n.nextElementSibling.style.display="none",s[c].name=t,o(s),l(!1,d()),r()}},u=e=>{let t=a();t=t.filter(t=>t.id!==e),o(t),l(!1,d()),r()},p=()=>{const e=a();let t=1;for(;e.find(e=>e.name===`新标签 ${t}`);)t++;return`新标签 ${t}`},y=e=>{const t=a(),n=e||p();if(t.some(e=>e.name===n))return g("标签已存在，请重新填写"),void console.log("添加了重复标签");const s=()=>{let e;do{e=(1e6*Math.random()).toFixed(0).toString()}while(t.some(t=>t.id===e));return e},c={id:s(),name:n,order:t.length+1};return t.push(c),o(t),l(!1,d()),r(),c},v=e=>{const t=a();e.forEach((e,n)=>{const a=t.find(t=>t.name===e);a&&(a.order=n+1)}),o(t),l(!1,d()),r()};document.querySelector('button[onclick="addNewTag()"]').addEventListener("click",y),window.renderTagsWrapper=l,window.getCurrentSelectedTagName=d,window.addNewTag=y});