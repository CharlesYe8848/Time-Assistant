document.addEventListener("DOMContentLoaded",()=>{function e(){document.body.style.overflow="hidden"}function t(){document.body.style.overflow="auto"}const n=[{id:"1",name:"推荐",order:1},{id:"2",name:"全部",order:2}];localStorage.getItem("tags")&&0!==JSON.parse(localStorage.getItem("tags")).length||localStorage.setItem("tags",JSON.stringify(n));const o=()=>{const e=JSON.parse(localStorage.getItem("tags"))||[];return e.sort((e,t)=>e.order-t.order)},l=e=>{localStorage.setItem("tags",JSON.stringify(e))},a=e=>{const t=JSON.parse(localStorage.getItem("events"))||[];return"2"===e?t.length:"1"===e?getRecommendedEvents(t).futureEvents.length+getRecommendedEvents(t).pastEvents.length:t.filter(t=>{const n=t.tagId.split(",").map(e=>e.trim());return n.includes(e)}).length},s=(e=!1,t=null)=>{console.log("Start renderTagsWrapper",{isInitialLoad:e,currentSelectedTagName:t});const n=document.getElementById("tags-wrapper"),l=n.querySelector(".tag.selected"),s=l?l.textContent.split(" ")[0]:null;console.log("Existing selected tag:",s);let d,c=localStorage.getItem("lastSelectedTagName"),r=localStorage.getItem("lastScrollPosition");console.log("Last selected tag from localStorage:",c),console.log("Last scroll position from localStorage:",r),n.innerHTML="";try{d=o(),console.log("Tags:",d)}catch(e){return void console.error("Failed to get tags:",e)}const i=(e,t=!0)=>{if(document.querySelectorAll(".tag").forEach(e=>{e.classList.remove("selected"),e.classList.add("unselected")}),e.classList.add("selected"),e.classList.remove("unselected"),t){const t=e.offsetLeft-(n.clientWidth/2-e.clientWidth/2);n.scroll({left:t,behavior:"smooth"})}};d.forEach((o,l)=>{console.log(`Rendering tag: ${o.name}, Index: ${l}`);const d=document.createElement("div");d.className="tag unselected",d.textContent=`${o.name} ${a(o.id)}`,d.setAttribute("data-id",o.id);const r=e&&0===l&&!c||o.name===s||o.name===t||o.name===c;r&&(console.log(`Selecting tag: ${o.name}`),i(d,!1),(e||o.name===c)&&loadEvents(o.id)),n.appendChild(d),console.log(`Appended tag: ${o.name}, Classes: ${d.className}`),d.addEventListener("click",function(){console.log("Tag clicked:",this.textContent),i(this,!0),loadEvents(this.getAttribute("data-id")),localStorage.setItem("lastSelectedTagName",this.textContent.split(" ")[0]),console.log("Saved last selected tag to localStorage:",this.textContent.split(" ")[0])})}),e&&d.length>0&&!c&&(console.log(`Loading events for first tag: ${d[0].name}`),loadEvents(d[0].id)),r&&(n.scrollLeft=r,console.log("Restored scroll position:",r)),n.addEventListener("scroll",()=>{clearTimeout(n._scrollTimeout),n._scrollTimeout=setTimeout(()=>{localStorage.setItem("lastScrollPosition",n.scrollLeft),console.log("Stored scroll position to localStorage:",n.scrollLeft)},100)}),console.log("End renderTagsWrapper")};s(!0);const d=()=>{const e=document.querySelector(".tag.selected");return e?e.textContent.split(" ")[0]:null},c=()=>{e(),document.getElementById("tagManagementModal").style.display="block",i()},r=()=>{t(),document.getElementById("tagManagementModal").style.display="none"};document.querySelector(".menu-icon").addEventListener("click",c),document.querySelector(".close").addEventListener("click",r);const i=()=>{const e=document.querySelector(".tags-list");e.innerHTML="";const t=o();t.forEach((t,n)=>{const o=document.createElement("div");o.className="tag-item",o.draggable=!0;const l=document.createElement("span");l.className="drag-handle",l.innerText="☰";const s=document.createElement("div");s.style.position="relative";const d=document.createElement("input");d.type="text",d.value=t.name,d.className="tag-name-input",d.disabled="推荐"===t.name||"全部"===t.name,d.onchange=(()=>m(t.id,d.value,d));const c=document.createElement("div");c.className="red-text",c.style.display="none",s.appendChild(d),s.appendChild(c);const r=document.createElement("button");r.innerText="删除",r.className="delete-button","推荐"===t.name||"全部"===t.name?(r.classList.add("disabled"),r.disabled=!0):r.addEventListener("click",()=>{const e=a(t.id);e>0?alert("当前标签下面存在"+e+"个事件，暂时不支持删除"):u(t.id)}),o.appendChild(l),o.appendChild(s),o.appendChild(r),e.appendChild(o),o.addEventListener("dragstart",e=>{e.dataTransfer.setData("text/plain",t.id),e.target.classList.add("dragging")}),o.addEventListener("dragover",e=>{e.preventDefault();const t=document.querySelector(".dragging"),n=e.clientY-o.getBoundingClientRect().top>o.clientHeight/2;n?o.parentNode.insertBefore(t,o.nextSibling):o.parentNode.insertBefore(t,o)}),o.addEventListener("dragend",e=>{e.target.classList.remove("dragging");const t=[...document.querySelectorAll(".tag-item input")].map(e=>e.value);S(t)})})},g=e=>{const t=document.getElementById("tip-message");t.textContent=e,t.style.display="block",t.style.opacity="1",setTimeout(()=>{t.style.transition="opacity 1s",t.style.opacity="0",setTimeout(()=>{t.style.display="none",t.style.transition=""},1e3)},2e3)},m=(e,t,n)=>{const a=o(),c=a.findIndex(t=>t.id===e);if(-1!==c){if(a.some(e=>e.name===t))return n.nextElementSibling.style.display="block",n.nextElementSibling.textContent="标签已存在，请重新填写",void g("标签已存在，请重新填写");n.nextElementSibling.style.display="none",a[c].name=t,l(a),s(!1,d()),i()}},u=e=>{let t=o();t=t.filter(t=>t.id!==e),l(t),s(!1,d()),i()},p=()=>{const e=o();let t=1;for(;e.find(e=>e.name===`新标签 ${t}`);)t++;return`新标签 ${t}`},y=e=>{const t=o(),n=e||p();if(t.some(e=>e.name===n))return g("标签已存在，请重新填写"),void console.log("添加了重复标签");const a=()=>{let e;do{e=(1e6*Math.random()).toFixed(0).toString()}while(t.some(t=>t.id===e));return e},c={id:a(),name:n,order:t.length+1};return t.push(c),l(t),s(!1,d()),i(),c},S=e=>{const t=o();e.forEach((e,n)=>{const o=t.find(t=>t.name===e);o&&(o.order=n+1)}),l(t),s(!1,d()),i()};window.renderTagsWrapper=s,window.getCurrentSelectedTagName=d,window.addNewTag=y,document.querySelector('button[onclick="addNewTag()"]').addEventListener("click",()=>y())});